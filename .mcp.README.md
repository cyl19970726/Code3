# Claude Code MCP 配置说明

> 如何在 Claude Code 中使用 aptos-chain-mcp 和 github-mcp-server

---

## 问题：Claude Code 不自动读取 .env 文件

Claude Code 的 `.mcp.json` 中使用 `${VARIABLE}` 语法时，只会读取**系统环境变量**，不会自动读取项目中的 `.env` 文件。

### ❌ 不工作的配置

```json
{
  "mcpServers": {
    "aptos-chain": {
      "command": "node",
      "args": ["${workspaceFolder}/spec-mcp/aptos-mcp/dist/index.js"],
      "env": {
        "APTOS_CONTRACT_ADDRESS": "${APTOS_CONTRACT_ADDRESS}"
      }
    }
  }
}
```

**问题**：`${APTOS_CONTRACT_ADDRESS}` 无法从 `.env` 文件读取，导致 MCP 服务器启动失败。

---

## 解决方案 1：自动读取 .env（推荐）✅

使用 bash 脚本在启动 MCP 服务器前先 source `.env` 文件。

**配置**（`Code3/.mcp.json`）：

```json
{
  "mcpServers": {
    "aptos-chain": {
      "command": "bash",
      "args": [
        "-c",
        "set -a && source ${workspaceFolder}/.env && set +a && node ${workspaceFolder}/spec-mcp/aptos-mcp/dist/index.js"
      ]
    },
    "github": {
      "command": "bash",
      "args": [
        "-c",
        "set -a && source ${workspaceFolder}/.env && set +a && docker run -i --rm -e GITHUB_PERSONAL_ACCESS_TOKEN=$GITHUB_PERSONAL_ACCESS_TOKEN ghcr.io/github/github-mcp-server"
      ]
    }
  }
}
```

**优点**：
- ✅ 无需手动设置环境变量
- ✅ 重启 Claude Code 后自动生效
- ✅ `.env` 文件统一管理所有配置

**工作流程**：
1. Claude Code 启动时读取 `.mcp.json`
2. 执行 `bash -c "set -a && source .env && ..."`
3. `.env` 文件中的变量自动导出为环境变量
4. MCP 服务器启动，读取环境变量

---

## 解决方案 2：手动设置环境变量

在启动 Claude Code 前手动导出环境变量。

**步骤**：

```bash
# 1. 导出环境变量
cd /Users/hhh0x/workflows/doing/Code3
export $(cat .env | grep -v '^#' | grep -v '^$' | xargs)

# 2. 从终端启动 Claude Code
open -a "Claude Code"

# 3. 或从终端启动 code 命令
code .
```

**优点**：
- ✅ 灵活控制环境变量

**缺点**：
- ❌ 每次重启 Claude Code 都需要重新 export
- ❌ 不能直接双击打开 Claude Code

---

## 解决方案 3：硬编码环境变量（不推荐）

直接在 `.mcp.json` 中写入环境变量值。

**配置**：

```json
{
  "mcpServers": {
    "aptos-chain": {
      "command": "node",
      "args": [
        "${workspaceFolder}/spec-mcp/aptos-mcp/dist/index.js"
      ],
      "env": {
        "APTOS_CONTRACT_ADDRESS": "0xafd0c08dbf36230f9b96eb1d23ff7ee223ad40be47917a0aba310ed90ac422a1",
        "APTOS_PRIVATE_KEY": "0xd38396d0b2c37d930de3eba9d45af4e209f6c3e05eb46c44dc68eaaba3236b34",
        "APTOS_NETWORK": "testnet"
      }
    }
  }
}
```

**缺点**：
- ❌ 私钥暴露在配置文件中
- ❌ 如果 `.mcp.json` 被提交到 Git，会泄露密钥

---

## 推荐配置（当前使用）

**文件结构**：

```
Code3/
├── .env                    # 环境变量（gitignored）
├── .mcp.json               # MCP 配置（自动读取 .env）
└── spec-mcp/aptos-mcp/
    └── dist/index.js       # MCP 服务器
```

**`.env` 文件**：

```bash
# GitHub MCP
GITHUB_PERSONAL_ACCESS_TOKEN=github_pat_...

# Aptos Chain MCP
APTOS_NETWORK=testnet
APTOS_CONTRACT_ADDRESS=0xafd0c08...
APTOS_PRIVATE_KEY=0xd38396d0...
```

**`.mcp.json` 文件**：

```json
{
  "mcpServers": {
    "aptos-chain": {
      "command": "bash",
      "args": [
        "-c",
        "set -a && source ${workspaceFolder}/.env && set +a && node ${workspaceFolder}/spec-mcp/aptos-mcp/dist/index.js"
      ]
    },
    "github": {
      "command": "bash",
      "args": [
        "-c",
        "set -a && source ${workspaceFolder}/.env && set +a && docker run -i --rm -e GITHUB_PERSONAL_ACCESS_TOKEN=$GITHUB_PERSONAL_ACCESS_TOKEN ghcr.io/github/github-mcp-server"
      ]
    }
  }
}
```

**使用方式**：

1. 确保 `.env` 文件存在且包含所有必需变量
2. 打开 Claude Code
3. MCP 服务器自动加载（无需手动操作）

**验证 MCP 已加载**：

```
User: 列出可用的 Aptos Chain MCP 工具

AI: 可用工具：
    - create_bounty
    - accept_bounty
    - submit_pr
    - mark_merged
    - claim_payout
    - cancel_bounty
```

---

## 调试 MCP 加载问题

### 1. 检查 .env 文件格式

```bash
# 查看 .env 文件（确保没有语法错误）
cat Code3/.env

# 测试 source 命令
bash -c "set -a && source Code3/.env && set +a && env | grep APTOS"
```

### 2. 检查 MCP 服务器是否编译

```bash
cd Code3/spec-mcp/aptos-mcp
npm run build
ls -la dist/index.js  # 应该存在
```

### 3. 手动测试 MCP 服务器启动

```bash
cd Code3
export $(cat .env | xargs)
node spec-mcp/aptos-mcp/dist/index.js
```

**预期输出**：

```
MCP Server started on stdio
Network: testnet
Contract: 0xafd0c08...
```

### 4. 查看 Claude Code MCP 日志

Claude Code 的 MCP 日志通常在：
- macOS: `~/Library/Logs/Claude/mcp.log`
- 或在 Claude Code 输出面板查看

---

## 常见问题

### Q1: MCP 服务器启动但没有工具显示

**原因**：环境变量未正确加载

**解决**：
```bash
# 检查环境变量是否在 MCP 服务器进程中
ps aux | grep "aptos-mcp"
```

### Q2: Docker 容器无法启动（github MCP）

**原因**：Docker 未运行或 `GITHUB_PERSONAL_ACCESS_TOKEN` 未设置

**解决**：
```bash
# 启动 Docker Desktop
open -a Docker

# 检查 .env 文件中是否有 GITHUB_PERSONAL_ACCESS_TOKEN
grep GITHUB_PERSONAL_ACCESS_TOKEN Code3/.env
```

### Q3: 修改 .env 后 MCP 未更新

**原因**：Claude Code 未重启

**解决**：重启 Claude Code 或重新加载窗口

---

## 安全提示

1. ✅ `.env` 文件已在 `.gitignore` 中
2. ✅ 使用 `bash` source 方式，环境变量仅在 MCP 进程中有效
3. ⚠️ 不要将 `.env` 文件提交到 Git
4. ⚠️ 不要在 `.mcp.json` 中硬编码私钥

---

## 参考

- [Claude Code MCP 文档](https://docs.claude.com/en/docs/claude-code/mcp)
- [aptos-chain-mcp README](./spec-mcp/aptos-mcp/README.md)
- [GitHub MCP Server](https://github.com/github/github-mcp-server)
